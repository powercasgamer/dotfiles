#!/bin/bash

# Global variables
readonly LOG_FILE="/var/log/user_creation.log"
readonly ALLOWED_KEYS="/home/dotfiles/allowed_keys"
readonly MAX_USERNAME_LENGTH=32
readonly DEFAULT_SHELL="/bin/zsh"

# Function to log messages
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') : $1" | tee -a "$LOG_FILE"
}

# Check if Zsh is installed
check_zsh_installed() {
    if ! command -v zsh >/dev/null 2>&1; then
        log_message "Error: zsh is not installed. Install it with 'apt install zsh' or 'yum install zsh'."
        exit 1
    fi
}

# Function to validate username
validate_username() {
    local username="$1"

    if [ -z "$username" ] || [ "${#username}" -gt "$MAX_USERNAME_LENGTH" ]; then
        log_message "Error: Username must be 1-$MAX_USERNAME_LENGTH characters long."
        return 1
    fi

    if ! [[ "$username" =~ ^[a-z_][a-z0-9_-]*$ ]]; then
        log_message "Error: Invalid username. Must start with a letter/underscore and contain only [a-z0-9_-]."
        return 1
    fi

    if id -u "$username" >/dev/null 2>&1; then
        log_message "Error: User '$username' already exists."
        return 1
    fi

    return 0
}

# Setup SSH for user
setup_ssh() {
    local username="$1"
    local user_home="/home/$username"
    local user_ssh_dir="$user_home/.ssh"

    mkdir -p "$user_ssh_dir" || return 1
    cp "$ALLOWED_KEYS" "$user_ssh_dir/authorized_keys" || return 1
    chown -R "$username:$username" "$user_ssh_dir" || return 1
    chmod 700 "$user_ssh_dir" || return 1
    chmod 600 "$user_ssh_dir/authorized_keys" || return 1

    return 0
}

# Main function
main() {
    if [ "$(id -u)" -ne 0 ]; then
        log_message "Error: This script must be run as root."
        exit 1
    fi

    check_zsh_installed  # Verify zsh is installed before proceeding

    local username
    if [ -z "$1" ]; then
        read -rp "Enter the new username: " username
    else
        username="$1"
    fi

    if ! validate_username "$username"; then
        exit 1
    fi

    if [ ! -f "$ALLOWED_KEYS" ]; then
        log_message "Error: SSH keys file not found at $ALLOWED_KEYS."
        exit 1
    fi

    # Create user with zsh as default shell, proper home directory, and no password
    if ! adduser --home "/home/$username" --shell "$DEFAULT_SHELL" --gecos "" --disabled-password "$username"; then
        log_message "Error: Failed to create user '$username'."
        exit 1
    fi

    if ! usermod -aG sudo "$username"; then
        log_message "Error: Failed to add '$username' to sudo group."
        exit 1
    fi

    if ! setup_ssh "$username"; then
        log_message "Error: SSH setup failed for '$username'."
        exit 1
    fi

    log_message "Success: User '$username' created with zsh, sudo access, and SSH keys."
    echo "âœ… User '$username' created successfully."
}

main "$@"